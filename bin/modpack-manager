#!/usr/bin/env python3
"""
Modpack Manager - Manage mods, generate modpacks, and create wiki pages.

This script loads a virtual environment from bin/venv and runs the mpmanager
package.
"""

import os
import sys
from pathlib import Path

# Get the script directory (bin/)
SCRIPT_DIR = Path(__file__).resolve().parent
REPO_ROOT = SCRIPT_DIR.parent

# Add bin/mpmanager to Python path
MPMANAGER_DIR = SCRIPT_DIR / "mpmanager"
sys.path.insert(0, str(MPMANAGER_DIR))

# Create venv if it doesn't exist
VENV_DIR = SCRIPT_DIR / "venv"
if not VENV_DIR.exists():
    print("Creating virtual environment...")
    import subprocess
    result = subprocess.run(
        [sys.executable, "-m", "venv", str(VENV_DIR)],
        cwd=str(SCRIPT_DIR),
        capture_output=True,
        text=True
    )
    if result.returncode != 0:
        print(f"Error creating virtual environment: {result.stderr}", file=sys.stderr)
        sys.exit(1)
    
    # Install dependencies
    venv_pip = VENV_DIR / "bin" / "pip"
    requirements_file = SCRIPT_DIR / "requirements.txt"
    if requirements_file.exists():
        print("Installing dependencies...")
        result = subprocess.run(
            [str(venv_pip), "install", "-r", str(requirements_file)],
            cwd=str(SCRIPT_DIR),
            capture_output=True,
            text=True
        )
        if result.returncode != 0:
            print(f"Error installing dependencies: {result.stderr}", file=sys.stderr)
            sys.exit(1)
    print("Virtual environment created and dependencies installed.")

# Use venv if we're not already using it
if sys.executable != str(VENV_DIR / "bin" / "python"):
    venv_python = VENV_DIR / "bin" / "python"
    if venv_python.exists():
        # Use venv Python if available
        os.execv(str(venv_python), [str(venv_python)] + sys.argv)

# Import and run the CLI
from mpmanager.cli import main

if __name__ == "__main__":
    sys.exit(main())
